# ã‚³ã‚¢ã‚³ãƒ³ã‚»ãƒ—ãƒˆ

> agent-contractsã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®è©³ç´°

---

## æ¦‚è¦

`agent-contracts`ã¯ã‚·ãƒ³ãƒ—ãƒ«ãªåŸå‰‡ã«åŸºã¥ã„ã¦ã„ã¾ã™ï¼š**ãƒãƒ¼ãƒ‰ãŒä½•ã‚’ã™ã‚‹ã‹ã‚’å®£è¨€ã—ã€ã©ã†æ¥ç¶šã™ã‚‹ã‹ã¯å®£è¨€ã—ãªã„**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Registry                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ NodeA     â”‚  â”‚ NodeB     â”‚  â”‚ NodeC     â”‚  ...          â”‚
â”‚  â”‚ CONTRACT  â”‚  â”‚ CONTRACT  â”‚  â”‚ CONTRACT  â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     GraphBuilder                             â”‚
â”‚  â€¢ ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚’åˆ†æ                                         â”‚
â”‚  â€¢ ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒã‚¤ã‚¶ãƒ¼ã‚’ä½œæˆ                                     â”‚
â”‚  â€¢ LangGraphã‚’è‡ªå‹•é…ç·š                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      LangGraph                               â”‚
â”‚  START â†’ Supervisor âŸ· Nodes â†’ END                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## NodeContract

`NodeContract`ã¯ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ä¸­å¿ƒã§ã™ã€‚ãƒãƒ¼ãƒ‰ã«é–¢ã™ã‚‹ã™ã¹ã¦ã‚’å®£è¨€ã—ã¾ã™ï¼š

```python
NodeContract(
    # === è­˜åˆ¥ ===
    name="my_node",                    # ä¸€æ„ã®è­˜åˆ¥å­
    description="ã“ã®ãƒãƒ¼ãƒ‰ã®å½¹å‰²", # äººé–“ãŒèª­ã‚ã‚‹èª¬æ˜
    
    # === I/Oå®šç¾© ===
    reads=["request", "context"],      # èª­ã¿å–ã‚‹ã‚¹ãƒ†ãƒ¼ãƒˆã‚¹ãƒ©ã‚¤ã‚¹
    writes=["response"],               # æ›¸ãè¾¼ã‚€ã‚¹ãƒ†ãƒ¼ãƒˆã‚¹ãƒ©ã‚¤ã‚¹
    
    # === ä¾å­˜é–¢ä¿‚ ===
    requires_llm=True,                 # LLMãŒå¿…è¦ã‹
    services=["db_service"],           # å¿…è¦ãªå¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹
    
    # === ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚° ===
    supervisor="main",                 # ç®¡ç†ã™ã‚‹ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒã‚¤ã‚¶ãƒ¼
    trigger_conditions=[...],          # ãƒãƒ¼ãƒ‰ã‚’èµ·å‹•ã™ã‚‹æ¡ä»¶
    is_terminal=False,                 # å®Ÿè¡Œå¾Œã«ãƒ•ãƒ­ãƒ¼ã‚’çµ‚äº†ã™ã‚‹ã‹
)
```

### ãªãœã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‹ï¼Ÿ

| ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆãªã— | ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚ã‚Š |
|-----------------|-----------------|
| æ‰‹å‹•ã§ã‚°ãƒ©ãƒ•ã‚’é…ç·š | è‡ªå‹•ã‚°ãƒ©ãƒ•æ§‹ç¯‰ |
| ä¾å­˜é–¢ä¿‚ãŒéš ã‚Œã¦ã„ã‚‹ | æ˜ç¤ºçš„ãªI/Oå®£è¨€ |
| ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚¨ãƒ©ãƒ¼ | é™çš„æ¤œè¨¼ |
| ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–ãŒå›°é›£ | è‡ªå‹•ç”Ÿæˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ |

---

## ã‚¹ãƒ†ãƒ¼ãƒˆã‚¹ãƒ©ã‚¤ã‚¹

`agent-contracts`ã®ã‚¹ãƒ†ãƒ¼ãƒˆã¯ç‹¬ç«‹ã—ãŸ**ã‚¹ãƒ©ã‚¤ã‚¹**ã«æ•´ç†ã•ã‚Œã¾ã™ï¼š

```python
state = {
    "request": {           # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®å…¥åŠ›
        "action": "search",
        "params": {"query": "laptop"}
    },
    "response": {          # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å‡ºåŠ›
        "response_type": "results",
        "data": [...]
    },
    "context": {           # å…±æœ‰ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
        "user_preferences": {...}
    },
    "_internal": {         # ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯å†…éƒ¨
        "decision": "search_node",
        "iteration": 1
    }
}
```

### è¨­è¨ˆåŸå‰‡

1. **é–¢å¿ƒã®åˆ†é›¢**: å„ã‚¹ãƒ©ã‚¤ã‚¹ã¯å˜ä¸€ã®ç›®çš„ã‚’æŒã¤
2. **æ˜ç¤ºçš„ã‚¢ã‚¯ã‚»ã‚¹**: ãƒãƒ¼ãƒ‰ã¯èª­ã¿æ›¸ãã™ã‚‹ã‚¹ãƒ©ã‚¤ã‚¹ã‚’å®£è¨€
3. **æ¤œè¨¼**: ä¸æ˜ãªã‚¹ãƒ©ã‚¤ã‚¹ã¯ã‚¨ãƒ©ãƒ¼ã‚’ãƒˆãƒªã‚¬ãƒ¼

### çµ„ã¿è¾¼ã¿ã‚¹ãƒ©ã‚¤ã‚¹

| ã‚¹ãƒ©ã‚¤ã‚¹ | ç›®çš„ |
|----------|------|
| `request` | ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨æ¨å¥¨ï¼‰ |
| `response` | ãƒ¦ãƒ¼ã‚¶ãƒ¼å‡ºåŠ› |
| `_internal` | ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°/ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ |

ã‚«ã‚¹ã‚¿ãƒ ã‚¹ãƒ©ã‚¤ã‚¹ã‚’å®šç¾©å¯èƒ½ï¼š

```python
registry.add_valid_slice("shopping")
registry.add_valid_slice("interview")
```

---

## TriggerCondition

ãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶ã¯ãƒãƒ¼ãƒ‰ãŒé¸æŠã•ã‚Œã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’åˆ¶å¾¡ã—ã¾ã™ï¼š

```python
TriggerCondition(
    priority=10,                           # é«˜ã„ = å…ˆã«è©•ä¾¡
    when={"request.action": "search"},     # ãƒãƒƒãƒæ¡ä»¶
    when_not={"response.done": True},      # å¦å®šãƒãƒƒãƒ
    llm_hint="å•†å“æ¤œç´¢ã«ä½¿ç”¨",               # LLMãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ’ãƒ³ãƒˆ
)
```

### å„ªå…ˆåº¦ãƒ¬ãƒ™ãƒ«

| ç¯„å›² | ç”¨é€” | ä¾‹ |
|------|------|----|
| ğŸ”´ 100+ | ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«/å³æ™‚ | ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ© |
| ğŸŸ¡ 50-99 | ä¸»è¦ãƒãƒ³ãƒ‰ãƒ© | ãƒ¡ã‚¤ãƒ³ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ |
| ğŸŸ¢ 1-49 | ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒ³ãƒ‰ãƒ© |
| âšª 0 | å¸¸ã«ãƒãƒƒãƒ | ã‚­ãƒ£ãƒƒãƒã‚ªãƒ¼ãƒ« |

### æ¡ä»¶ãƒãƒƒãƒãƒ³ã‚°

```python
# æ­£ç¢ºãªå€¤ãƒãƒƒãƒ
when={"request.action": "search"}

# ãƒ–ãƒ¼ãƒ«å€¤ãƒã‚§ãƒƒã‚¯
when={"context.authenticated": True}

# ãƒã‚¹ãƒˆãƒ‘ã‚¹
when={"request.params.category": "electronics"}

# è¤‡æ•°æ¡ä»¶ (AND)
when={"request.action": "buy", "context.cart_ready": True}
```

---

## GenericSupervisor

ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒã‚¤ã‚¶ãƒ¼ã¯å¤šæ®µéšã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§ãƒãƒ¼ãƒ‰é¸æŠã‚’èª¿æ•´ã—ã¾ã™ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ±ºå®šãƒ•ãƒ­ãƒ¼                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. çµ‚äº†çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯                                         â”‚
â”‚     â””â”€ response_type ãŒ terminal_states ã«å«ã¾ã‚Œã‚‹ â†’ done    â”‚
â”‚                                                              â”‚
â”‚  2. æ˜ç¤ºçš„ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°                                       â”‚
â”‚     â””â”€ action="answer" â†’ è³ªå•ã®é€ä¿¡å…ƒã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°          â”‚
â”‚                                                              â”‚
â”‚  3. ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹è©•ä¾¡                                         â”‚
â”‚     â””â”€ å…¨TriggerConditionã‚’è©•ä¾¡ã€å€™è£œã‚’åé›†                  â”‚
â”‚                                                              â”‚
â”‚  4. LLMæ±ºå®šï¼ˆåˆ©ç”¨å¯èƒ½ãªå ´åˆï¼‰                                â”‚
â”‚     â””â”€ LLMãŒllm_hintsã‚’ä½¿ç”¨ã—ã¦å€™è£œã‹ã‚‰é¸æŠ                  â”‚
â”‚                                                              â”‚
â”‚  5. ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯                                           â”‚
â”‚     â””â”€ æœ€é«˜å„ªå…ˆåº¦ã®ãƒ«ãƒ¼ãƒ«ãƒãƒƒãƒã‚’ä½¿ç”¨                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### LLMã‚ã‚Š vs ãªã—

| ãƒ¢ãƒ¼ãƒ‰ | å‹•ä½œ |
|--------|------|
| **LLMã‚ã‚Š** | LLMãŒãƒ«ãƒ¼ãƒ«ãƒ’ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¦æœ€çµ‚æ±ºå®š |
| **LLMãªã—** | ç´”ç²‹ãªãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã€æœ€é«˜å„ªå…ˆåº¦ãƒãƒƒãƒã‚’ä½¿ç”¨ |

---

## InteractiveNode

ä¼šè©±å‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ã¯`InteractiveNode`ã‚’ä½¿ç”¨ï¼š

```python
from agent_contracts import InteractiveNode


class InterviewNode(InteractiveNode):
    CONTRACT = NodeContract(...)
    
    def prepare_context(self, inputs):
        """å…¥åŠ›ã‹ã‚‰ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º"""
        return inputs.get_slice("interview")
    
    def check_completion(self, context, inputs):
        """ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼å®Œäº†ã‚’ãƒã‚§ãƒƒã‚¯"""
        return len(context.get("answers", [])) >= 5
    
    async def process_answer(self, context, inputs, config=None):
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å›ç­”ã‚’å‡¦ç†"""
        answer = inputs.get_slice("request").get("answer")
        # å›ç­”ã‚’ä¿å­˜...
        return True
    
    async def generate_question(self, context, inputs, config=None):
        """æ¬¡ã®è³ªå•ã‚’ç”Ÿæˆ"""
        # LLMã§è³ªå•ã‚’ç”Ÿæˆ...
        return NodeOutputs(response={"question": "ã©ã®è‰²ãŒå¥½ãã§ã™ã‹ï¼Ÿ"})
```

### ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  InteractiveNode ãƒ•ãƒ­ãƒ¼                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. prepare_context()     â†’ å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º               â”‚
â”‚  2. check_completion()    â†’ æ—¢ã«å®Œäº†ï¼Ÿ                       â”‚
â”‚       â””â”€ Yes â†’ create_completion_output()                    â”‚
â”‚       â””â”€ No â†“                                               â”‚
â”‚  3. process_answer()      â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¿œç­”ã‚’å‡¦ç†             â”‚
â”‚  4. check_completion()    â†’ ä»Šå®Œäº†ï¼Ÿ                         â”‚
â”‚       â””â”€ Yes â†’ create_completion_output()                    â”‚
â”‚       â””â”€ No â†’ generate_question()                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ContractValidator

å®Ÿè¡Œå‰ã«ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚’æ¤œè¨¼ï¼š

```python
from agent_contracts import ContractValidator

validator = ContractValidator(
    registry,
    known_services={"db_service", "cache_service"},
)
result = validator.validate()

if result.has_errors:
    print(result)  # ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
    exit(1)
```

### æ¤œè¨¼ãƒ¬ãƒ™ãƒ«

| ãƒ¬ãƒ™ãƒ« | ä¾‹ |
|--------|-----|
| **ERROR** | reads/writesã®ä¸æ˜ãªã‚¹ãƒ©ã‚¤ã‚¹ |
| **WARNING** | ä¸æ˜ãªã‚µãƒ¼ãƒ“ã‚¹ã€åˆ°é”ä¸èƒ½ãƒãƒ¼ãƒ‰ |
| **INFO** | å…±æœ‰ãƒ©ã‚¤ã‚¿ãƒ¼ï¼ˆè¤‡æ•°ãƒãƒ¼ãƒ‰ãŒåŒã˜ã‚¹ãƒ©ã‚¤ã‚¹ã«æ›¸ãè¾¼ã¿ï¼‰ |


---

## StateSummarizer

å†å¸°çš„ãªæ§‹é€ ä¿æŒã‚’ä¼´ã†ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆãªã‚¹ãƒ†ãƒ¼ãƒˆã‚¹ãƒ©ã‚¤ã‚¹è¦ç´„ï¼š

```python
from agent_contracts.utils import StateSummarizer, summarize_state_slice

# ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã§ã‚µãƒãƒ©ã‚¤ã‚¶ãƒ¼ã‚’ä½œæˆ
summarizer = StateSummarizer(
    max_depth=2,          # æœ€å¤§å†å¸°æ·±åº¦
    max_dict_items=3,     # ãƒ¬ãƒ™ãƒ«ã”ã¨ã®æœ€å¤§è¾æ›¸é …ç›®æ•°
    max_list_items=2,     # ãƒ¬ãƒ™ãƒ«ã”ã¨ã®æœ€å¤§ãƒªã‚¹ãƒˆé …ç›®æ•°
    max_str_length=50,    # æœ€å¤§æ–‡å­—åˆ—é•·
)

# è¤‡é›‘ãªãƒã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è¦ç´„
profile = {
    "user_id": "user123",
    "preferences": {
        "style": "casual",
        "colors": ["blue", "green", "red"],
        "brands": ["Nike", "Adidas", "Puma", "Reebok"],
    },
    "history": [
        {"item": "shirt", "date": "2024-01-01"},
        {"item": "pants", "date": "2024-01-02"},
    ]
}

summary = summarizer.summarize(profile)
# å‡ºåŠ›: {'user_id': 'user123', 'preferences': {'style': 'casual', 
#        'colors': [...] (3 items), 'brands': [...] (4 items)}, 
#        'history': [{'item', 'date'} (2 items), ...] (2 items)}

# ã¾ãŸã¯ä¾¿åˆ©é–¢æ•°ã‚’ä½¿ç”¨
summary = summarize_state_slice(profile, max_depth=2)
```

### ä¸»ãªæ©Ÿèƒ½

- **å†å¸°çš„ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«**: ãƒã‚¹ãƒˆæ§‹é€ ã‚’ä¿æŒï¼ˆãƒªã‚¹ãƒˆå†…ã®è¾æ›¸ã€è¾æ›¸å†…ã®ãƒªã‚¹ãƒˆãªã©ï¼‰
- **æ·±åº¦åˆ¶é™**: éåº¦ãªãƒã‚¹ãƒˆã‚’é˜²æ­¢ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 2ãƒ¬ãƒ™ãƒ«ï¼‰
- **é …ç›®æ•°åˆ¶å¾¡**: ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã”ã¨ã«è¡¨ç¤ºã™ã‚‹é …ç›®æ•°ã‚’åˆ¶é™ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: è¾æ›¸3å€‹ã€ãƒªã‚¹ãƒˆ2å€‹ï¼‰
- **æ§‹é€ ä¿æŒ**: ã‚­ãƒ¼ã ã‘ã§ãªãéšå±¤é–¢ä¿‚ã‚’è¡¨ç¤º
- **ã‚µã‚¤ã‚ºè¡¨ç¤º**: åˆ‡ã‚Šè©°ã‚ã‚‰ã‚ŒãŸã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ç·é …ç›®æ•°ã‚’è¡¨ç¤º

### ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹

1. **LLMã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ§‹ç¯‰**: ãƒˆãƒ¼ã‚¯ãƒ³äºˆç®—ã‚’åœ§è¿«ã›ãšã«ãƒªãƒƒãƒãªã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æä¾›
2. **ãƒ‡ãƒãƒƒã‚°**: è¤‡é›‘ãªã‚¹ãƒ†ãƒ¼ãƒˆæ§‹é€ ã®æ¦‚è¦ã‚’ç´ æ—©ãæŠŠæ¡
3. **ãƒ­ã‚®ãƒ³ã‚°**: å¤§è¦æ¨¡ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®ç°¡æ½”ãªè¡¨ç¾
4. **APIãƒ¬ã‚¹ãƒãƒ³ã‚¹**: ãƒã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®äººé–“ãŒèª­ã¿ã‚„ã™ã„è¦ç´„

### Supervisorã¨ã®çµ±åˆ

`GenericSupervisor`ã¯è‡ªå‹•çš„ã«`StateSummarizer`ã‚’ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ§‹ç¯‰ã«ä½¿ç”¨ï¼š

```python
supervisor = GenericSupervisor("shopping", llm=llm)
# å†…éƒ¨çš„ã«_summarize_slice()ã§StateSummarizerã‚’ä½¿ç”¨
decision = await supervisor.decide(state)
```

Supervisorã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«ã¯ä»¥ä¸‹ãŒå«ã¾ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸï¼š
- ãƒã‚¹ãƒˆæ§‹é€ ã®å¯è¦–æ€§ï¼ˆãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã®ã‚­ãƒ¼ã ã‘ã§ãªãï¼‰
- å¤§è¦æ¨¡ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®æœ€åˆã®æ•°é …ç›®
- åˆ‡ã‚Šè©°ã‚ã‚‰ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã®ç·é …ç›®æ•°
- éšå±¤é–¢ä¿‚ã®ä¿æŒ

---

## ãƒˆãƒ¬ãƒ¼ã‚µãƒ–ãƒ«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

ãƒ‡ãƒãƒƒã‚°ã«ã¯`decide_with_trace()`ã‚’ä½¿ç”¨ï¼š

```python
decision = await supervisor.decide_with_trace(state)

print(f"é¸æŠ: {decision.selected_node}")
print(f"ã‚¿ã‚¤ãƒ—: {decision.reason.decision_type}")

for rule in decision.reason.matched_rules:
    print(f"  {rule.node} (P{rule.priority}): {rule.condition}")
```

### æ±ºå®šã‚¿ã‚¤ãƒ—

| ã‚¿ã‚¤ãƒ— | æ„å‘³ |
|--------|------|
| `terminal_state` | ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ—ãŒçµ‚äº†ã‚’ãƒˆãƒªã‚¬ãƒ¼ |
| `explicit_routing` | å›ç­”ãŒè³ªå•ã®é€ä¿¡å…ƒã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚° |
| `rule_match` | TriggerConditionãŒãƒãƒƒãƒ |
| `llm_decision` | LLMãŒé¸æŠ |
| `fallback` | ãƒãƒƒãƒãªã—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ä½¿ç”¨ |


## Supervisorã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ§‹ç¯‰

`GenericSupervisor`ã¯ã€å€™è£œãƒãƒ¼ãƒ‰ã®Contractã‚’åˆ†æã™ã‚‹ã“ã¨ã§ã€LLMãƒ™ãƒ¼ã‚¹ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°åˆ¤æ–­ã®ãŸã‚ã®è±Šå¯Œãªã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è‡ªå‹•çš„ã«æ§‹ç¯‰ã—ã¾ã™ã€‚

### ä»•çµ„ã¿

SupervisorãŒãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°åˆ¤æ–­ã‚’è¡Œã†éš›ï¼š

1. **åŸºæœ¬ã‚¹ãƒ©ã‚¤ã‚¹ã®åé›†**: å¸¸ã«`request`ã€`response`ã€`_internal`ã‚’å«ã‚€
2. **å€™è£œã®åˆ†æ**: å„å€™è£œãƒãƒ¼ãƒ‰ã®Contractã®`reads`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’èª¿æŸ»
3. **ã‚¹ãƒ©ã‚¤ã‚¹ã®ãƒãƒ¼ã‚¸**: åŸºæœ¬ã‚¹ãƒ©ã‚¤ã‚¹ã¨å€™è£œå›ºæœ‰ã®ã‚¹ãƒ©ã‚¤ã‚¹ã‚’çµåˆ
4. **è¦ç´„**: å„ã‚¹ãƒ©ã‚¤ã‚¹ã‚’ç°¡æ½”ãªæ–‡å­—åˆ—è¡¨ç¾ã«å¤‰æ›
5. **LLMã¸ã®æä¾›**: å……å®Ÿã—ãŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ¸¡ã—ã¦æƒ…å ±ã«åŸºã¥ã„ãŸåˆ¤æ–­ã‚’å¯èƒ½ã«

### ä¾‹

```python
# ãƒãƒ¼ãƒ‰ã®Contract
node_a = NodeContract(
    name="profile_analyzer",
    reads=["request", "profile_card", "interview"],
    ...
)

node_b = NodeContract(
    name="search_handler",
    reads=["request", "search_history"],
    ...
)

# ä¸¡æ–¹ãŒå€™è£œã®å ´åˆã€Supervisorã¯ä»¥ä¸‹ã‚’æä¾›ï¼š
# - request (åŸºæœ¬)
# - response (åŸºæœ¬)
# - _internal (åŸºæœ¬)
# - profile_card (node_aã‹ã‚‰)
# - interview (node_aã‹ã‚‰)
# - search_history (node_bã‹ã‚‰)
```

### ãƒ¡ãƒªãƒƒãƒˆ

- **Contracté§†å‹•**: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å›ºæœ‰ã®çŸ¥è­˜ã¯ä¸è¦
- **åŠ¹ç‡çš„**: é–¢é€£ã™ã‚‹çŠ¶æ…‹æƒ…å ±ã®ã¿ã‚’å«ã‚€
- **è‡ªå‹•**: è¨­å®šãªã—ã§ã‚ã‚‰ã‚†ã‚‹ãƒãƒ¼ãƒ‰ã§å‹•ä½œ
- **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«**: æ–°ã—ã„ãƒãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¦ã‚‚è‡ªå‹•å¯¾å¿œ

### ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ§‹ç¯‰ã¯è‡ªå‹•ã§ã™ãŒã€ä»¥ä¸‹ã‚’é€šã˜ã¦å½±éŸ¿ã‚’ä¸ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š

1. **ãƒãƒ¼ãƒ‰ã®Contract**: ãƒãƒ¼ãƒ‰ãŒèª­ã¿å–ã‚‹ã‚‚ã®ã‚’å®£è¨€
2. **çŠ¶æ…‹ã®æ•´ç†**: ã‚¹ãƒ©ã‚¤ã‚¹ã‚’ç„¦ç‚¹ã‚’çµã£ã¦é©åˆ‡ã«å‘½å
3. **ã‚¹ãƒ©ã‚¤ã‚¹ã®ã‚µã‚¤ã‚º**: å¤§ããªã‚¹ãƒ©ã‚¤ã‚¹ã¯è‡ªå‹•çš„ã«åˆ‡ã‚Šè©°ã‚ã‚‰ã‚Œã‚‹

```python
# ã“ã®ãƒãƒ¼ãƒ‰ãŒå€™è£œã®å ´åˆã€Supervisorã¯è‡ªå‹•çš„ã«
# ã“ã‚Œã‚‰ã®ã‚¹ãƒ©ã‚¤ã‚¹ã‚’å«ã‚ã¾ã™
CONTRACT = NodeContract(
    name="my_node",
    reads=["request", "user_profile", "conversation_history"],
    ...
)
```

---

## StateAccessorãƒ‘ã‚¿ãƒ¼ãƒ³

å‹å®‰å…¨ã§ã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ãªçŠ¶æ…‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¢ã‚¯ã‚»ã‚¹ï¼š

```python
from agent_contracts import Internal, Request, Response, reset_response

# çŠ¶æ…‹ã®èª­ã¿å–ã‚Š
count = Internal.turn_count.get(state)
action = Request.action.get(state)

# çŠ¶æ…‹ã®æ›¸ãè¾¼ã¿ï¼ˆã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ« - æ–°ã—ã„stateã‚’è¿”ã™ï¼‰
state = Internal.turn_count.set(state, 5)
state = reset_response(state)
```

### åˆ©ç”¨å¯èƒ½ãªã‚¢ã‚¯ã‚»ã‚µãƒ¼

| ã‚¯ãƒ©ã‚¹ | ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ |
|-------|----------|
| `Internal` | `turn_count`, `is_first_turn`, `active_mode`, `next_node`, `error` |
| `Request` | `session_id`, `action`, `params`, `message`, `image` |
| `Response` | `response_type`, `response_data`, `response_message` |

### ä¾¿åˆ©é–¢æ•°

```python
from agent_contracts import increment_turn, set_error, clear_error

state = increment_turn(state)  # turn_count++, is_first_turn=False
state = set_error(state, "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ")
state = clear_error(state)
```

---

## Runtimeãƒ¬ã‚¤ãƒ¤ãƒ¼

æœ¬ç•ªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€çµ±åˆå®Ÿè¡Œã®ãŸã‚ã«Runtimeãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä½¿ç”¨ï¼š

### AgentRuntime

```python
from agent_contracts import AgentRuntime, RequestContext, InMemorySessionStore

runtime = AgentRuntime(
    graph=compiled_graph,
    session_store=InMemorySessionStore(),
)

result = await runtime.execute(RequestContext(
    session_id="abc123",
    action="answer",
    message="ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ãŒå¥½ã",
    resume_session=True,
))
```

### å®Ÿè¡Œãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  AgentRuntime ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. åˆæœŸçŠ¶æ…‹ã‚’ä½œæˆ                                           â”‚
â”‚  2. ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å¾©å…ƒï¼ˆresume_session=True ã®å ´åˆï¼‰            â”‚
â”‚  3. hooks.prepare_state() â†’ å®Ÿè¡Œå‰ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º               â”‚
â”‚  4. graph.ainvoke() â†’ LangGraphã‚’å®Ÿè¡Œ                        â”‚
â”‚  5. ExecutionResultã‚’æ§‹ç¯‰                                    â”‚
â”‚  6. hooks.after_execution() â†’ æ°¸ç¶šåŒ–ã€ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯

```python
from agent_contracts import RuntimeHooks

class MyHooks(RuntimeHooks):
    async def prepare_state(self, state, request):
        # çŠ¶æ…‹ã®æ­£è¦åŒ–ã€ãƒªã‚½ãƒ¼ã‚¹ã®èª­ã¿è¾¼ã¿
        return state
    
    async def after_execution(self, state, result):
        # ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿å­˜ã€ãƒ­ã‚°ãªã©
        await self.session_store.save(...)
```

### StreamingRuntimeï¼ˆSSEå¯¾å¿œï¼‰

```python
from agent_contracts.runtime import StreamingRuntime, StreamEventType

runtime = (
    StreamingRuntime()
    .add_node("search", search_node, "æ¤œç´¢ä¸­...")
    .add_node("stylist", stylist_node, "ç”Ÿæˆä¸­...")
)

async for event in runtime.stream(request):
    if event.type == StreamEventType.NODE_END:
        print(f"ãƒãƒ¼ãƒ‰ {event.node_name} å®Œäº†")
    yield event.to_sse()
```

---

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

- ğŸ¯ [ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹](best_practices.ja.md) - è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³
- ğŸ› [ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](troubleshooting.ja.md) - ã‚ˆãã‚ã‚‹å•é¡Œ
